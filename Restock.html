<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRV Processing System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #ffffff;
            color: #333333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            color: #000000;
            text-align: center;
            margin-bottom: 5px;
            font-size: 24px;
            font-weight: bold;
        }

        .subtitle {
            text-align: center;
            color: #666666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .current-grv {
            background-color: #0066cc;
            color: white;
            padding: 10px 15px;
            border-radius: 3px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }

        .form-section {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #000000;
            font-size: 13px;
        }

        .input-group input, .input-group select {
            padding: 10px;
            border: 1px solid #cccccc;
            border-radius: 3px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            border-color: #0066cc;
            outline: none;
        }

        .add-item-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
            display: block;
            margin: 0 auto;
        }

        .add-item-btn:hover {
            background-color: #218838;
        }

        .items-table-container {
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
        }

        th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            position: sticky;
            top: 0;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-delete {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-delete:hover {
            background-color: #c82333;
        }

        .process-section {
            background-color: #2c3e50;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            margin-top: 20px;
        }

        .process-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .process-btn:hover {
            background-color: #c82333;
        }

        .grv-summary {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        .grv-summary h3 {
            color: #000000;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .summary-item {
            background-color: white;
            padding: 12px;
            border-radius: 3px;
            border-left: 4px solid #0066cc;
        }

        .summary-label {
            font-size: 12px;
            color: #666666;
            margin-bottom: 3px;
        }

        .summary-value {
            font-size: 16px;
            font-weight: bold;
            color: #000000;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-pending {
            background-color: #ffc107;
            color: #000000;
        }

        .status-processed {
            background-color: #28a745;
            color: white;
        }

        .message {
            padding: 12px;
            border-radius: 3px;
            margin: 10px 0;
            text-align: center;
            display: none;
        }

        .message-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .grv-history-section {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .grv-history-section h3 {
            margin-bottom: 15px;
            color: #000000;
        }

        .history-table {
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .input-grid {
                grid-template-columns: 1fr;
            }
            
            th, td {
                padding: 8px 5px;
                font-size: 12px;
            }
            
            .process-btn {
                padding: 12px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>GRV PROCESSING SYSTEM</h1>
        <p class="subtitle">Add items and process as GRV files</p>
        
        <div class="current-grv" id="currentGRV">
            Currently Adding to: GRV-01
        </div>
        
        <div class="form-section">
            <h2 style="color: #000000; margin-bottom: 15px; font-size: 18px;">Add New Item</h2>
            <div class="input-grid">
                <div class="input-group">
                    <label for="itemCode">Item Code</label>
                    <input type="text" id="itemCode" placeholder="Enter item code" maxlength="20">
                </div>
                <div class="input-group">
                    <label for="itemName">Item Name</label>
                    <input type="text" id="itemName" placeholder="Enter item name">
                </div>
                <div class="input-group">
                    <label for="quantity">Quantity</label>
                    <input type="number" id="quantity" placeholder="Enter quantity" min="1" value="1">
                </div>
                <div class="input-group">
                    <label for="unitPrice">Unit Price</label>
                    <input type="number" id="unitPrice" placeholder="Enter price" min="0" step="0.01" value="0.00">
                </div>
                <div class="input-group">
                    <label for="supplier">Supplier</label>
                    <input type="text" id="supplier" placeholder="Enter supplier name">
                </div>
            </div>
            <button class="add-item-btn" onclick="addItem()">Add Item to List</button>
        </div>
        
        <div class="message" id="message"></div>
        
        <div class="items-table-container">
            <h2 style="color: #000000; margin-bottom: 10px; padding-left: 10px; font-size: 18px;">Items to Process</h2>
            <table id="itemsTable">
                <thead>
                    <tr>
                        <th>Item Code</th>
                        <th>Item Name</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total Price</th>
                        <th>Supplier</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody">
                    <!-- Items will be added here dynamically -->
                </tbody>
            </table>
        </div>
        
        <div class="grv-summary">
            <h3>GRV Summary</h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-label">Total Items</div>
                    <div class="summary-value" id="totalItems">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total Quantity</div>
                    <div class="summary-value" id="totalQuantity">0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total Value</div>
                    <div class="summary-value" id="totalValue">0.00</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Current GRV</div>
                    <div class="summary-value" id="currentGRVNumber">GRV-01</div>
                </div>
            </div>
        </div>
        
        <div class="process-section">
            <button class="process-btn" onclick="processGRV()">
                PROCESS GRV (Create GRV File)
            </button>
            <p style="color: #ffffff; margin-top: 10px; font-size: 13px;">
                Click to process all items above as a single GRV file
            </p>
        </div>
        
        <div class="grv-history-section">
            <h3>Processed GRV Files</h3>
            <div class="history-table">
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>GRV Number</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Items</th>
                            <th>Total Quantity</th>
                            <th>Total Value</th>
                        </tr>
                    </thead>
                    <tbody id="grvHistoryBody">
                        <!-- GRV history will be added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB-lm7Y3r1F6Vv8PKvY8glLabZDbJsHM1k",
            authDomain: "trismartstores.firebaseapp.com",
            projectId: "trismartstores",
            storageBucket: "trismartstores.firebasestorage.app",
            messagingSenderId: "416692703333",
            appId: "1:416692703333:web:d4b60292621435c748f68c",
            measurementId: "G-NJPQ7L3QWJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const branchId = localStorage.getItem('branchId');
        
        if (!branchId) {
            alert('Branch ID not found. Please select a branch from the dashboard.');
            window.location.href = 'dashboard.html';
        }

        let items = [];
        let currentGRV = 1;
        let processedGRVs = [];
        let inventory = [];

        // Get next GRV number from database
        async function getNextGRVNumber() {
            try {
                const grvCounterRef = doc(db, 'grvCounter', branchId);
                const grvCounterSnap = await getDoc(grvCounterRef);
                
                if (grvCounterSnap.exists()) {
                    currentGRV = grvCounterSnap.data().nextGRV;
                } else {
                    // Initialize with 1 if doesn't exist
                    await setDoc(grvCounterRef, { nextGRV: 1 });
                    currentGRV = 1;
                }
                updateGRVDisplay();
            } catch (error) {
                console.error('Error getting GRV number:', error);
                currentGRV = 1;
                updateGRVDisplay();
            }
        }

        // Fetch inventory for autocomplete
        async function fetchInventory() {
            try {
                const q = query(collection(db, 'inventory'), where('branchId', '==', branchId));
                const inventorySnapshot = await getDocs(q);
                inventory = inventorySnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    code: doc.data().code,
                    name: doc.data().name,
                    stock: doc.data().stock
                }));
            } catch (error) {
                console.error('Error fetching inventory:', error);
            }
        }

        // Load items from localStorage
        function loadLocalData() {
            const savedItems = localStorage.getItem('grvItems');
            if (savedItems) {
                items = JSON.parse(savedItems);
                updateTable();
                updateSummary();
            }
            
            const savedProcessed = localStorage.getItem('processedGRVs');
            if (savedProcessed) {
                processedGRVs = JSON.parse(savedProcessed);
                updateGRVHistory();
            }
        }

        // Save items to localStorage
        function saveLocalData() {
            localStorage.setItem('grvItems', JSON.stringify(items));
            localStorage.setItem('processedGRVs', JSON.stringify(processedGRVs));
        }

        // Update GRV display
        function updateGRVDisplay() {
            const grvNumber = currentGRV.toString().padStart(2, '0');
            document.getElementById('currentGRV').textContent = `Currently Adding to: GRV-${grvNumber}`;
            document.getElementById('currentGRVNumber').textContent = `GRV-${grvNumber}`;
        }

        // Add item to the list
        function addItem() {
            const itemCode = document.getElementById('itemCode').value.trim();
            const itemName = document.getElementById('itemName').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value);
            const unitPrice = parseFloat(document.getElementById('unitPrice').value);
            const supplier = document.getElementById('supplier').value.trim();
            
            if (!itemCode || !itemName || !quantity || quantity < 1 || !unitPrice || unitPrice < 0 || !supplier) {
                showMessage('Please fill in all fields with valid values', 'error');
                return;
            }
            
            const newItem = {
                id: Date.now(),
                code: itemCode,
                name: itemName,
                quantity: quantity,
                unitPrice: unitPrice,
                totalPrice: (quantity * unitPrice).toFixed(2),
                supplier: supplier,
                status: 'pending',
                grvNumber: `GRV-${currentGRV.toString().padStart(2, '0')}`,
                branchId: branchId
            };
            
            items.push(newItem);
            updateTable();
            updateSummary();
            saveLocalData();
            
            document.getElementById('itemCode').value = '';
            document.getElementById('itemName').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('unitPrice').value = '0.00';
            document.getElementById('supplier').value = '';
            
            showMessage(`Item "${itemName}" added successfully`, 'success');
            document.getElementById('itemCode').focus();
        }

        // Update the table with items
        function updateTable() {
            const tableBody = document.getElementById('itemsTableBody');
            tableBody.innerHTML = '';
            
            const currentGRVItems = items.filter(item => 
                item.grvNumber === `GRV-${currentGRV.toString().padStart(2, '0')}` && 
                item.branchId === branchId
            );
            
            if (currentGRVItems.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px; color: #666666;">
                            No items added yet. Add items using the form above.
                        </td>
                    </tr>
                `;
                return;
            }
            
            currentGRVItems.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.code}</td>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${parseFloat(item.unitPrice).toFixed(2)}</td>
                    <td>${item.totalPrice}</td>
                    <td>${item.supplier}</td>
                    <td><span class="status-badge ${item.status === 'pending' ? 'status-pending' : 'status-processed'}">${item.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-delete" onclick="deleteItem(${item.id})">Delete</button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Delete an item
        function deleteItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                items = items.filter(item => item.id !== id);
                updateTable();
                updateSummary();
                saveLocalData();
                showMessage('Item deleted successfully', 'success');
            }
        }

        // Update summary statistics
        function updateSummary() {
            const currentGRVItems = items.filter(item => 
                item.grvNumber === `GRV-${currentGRV.toString().padStart(2, '0')}` && 
                item.branchId === branchId
            );
            
            const totalItems = currentGRVItems.length;
            const totalQuantity = currentGRVItems.reduce((sum, item) => sum + item.quantity, 0);
            const totalValue = currentGRVItems.reduce((sum, item) => sum + parseFloat(item.totalPrice), 0);
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalQuantity').textContent = totalQuantity;
            document.getElementById('totalValue').textContent = totalValue.toFixed(2);
        }

        // Process GRV and save to database
        async function processGRV() {
            const currentGRVItems = items.filter(item => 
                item.grvNumber === `GRV-${currentGRV.toString().padStart(2, '0')}` && 
                item.status === 'pending' &&
                item.branchId === branchId
            );
            
            if (currentGRVItems.length === 0) {
                showMessage('No pending items to process for this GRV', 'error');
                return;
            }
            
            try {
                // Create GRV object
                const grv = {
                    grvNumber: `GRV-${currentGRV.toString().padStart(2, '0')}`,
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toLocaleTimeString(),
                    items: currentGRVItems,
                    totalItems: currentGRVItems.length,
                    totalQuantity: currentGRVItems.reduce((sum, item) => sum + item.quantity, 0),
                    totalValue: currentGRVItems.reduce((sum, item) => sum + parseFloat(item.totalPrice), 0),
                    branchId: branchId,
                    status: 'processed',
                    createdAt: new Date().toISOString()
                };
                
                // Save to GRV collection in Firebase
                const grvRef = await addDoc(collection(db, 'grvRecords'), grv);
                console.log('GRV saved to database with ID:', grvRef.id);
                
                // Update inventory stock for each item
                for (const item of currentGRVItems) {
                    // Find the item in inventory
                    const inventoryItem = inventory.find(inv => inv.code === item.code);
                    if (inventoryItem) {
                        // Update stock in inventory
                        const itemRef = doc(db, 'inventory', inventoryItem.id);
                        const newStock = (inventoryItem.stock || 0) + item.quantity;
                        await updateDoc(itemRef, { stock: newStock });
                        
                        // Add to restockHistory
                        const restockEntry = {
                            date: grv.date,
                            code: item.code,
                            name: item.name,
                            price: item.unitPrice,
                            quantity: item.quantity,
                            total: item.totalPrice,
                            branchId: branchId,
                            grvNumber: grv.grvNumber
                        };
                        await addDoc(collection(db, 'restockHistory'), restockEntry);
                    }
                }
                
                // Update GRV counter for next GRV
                const grvCounterRef = doc(db, 'grvCounter', branchId);
                await setDoc(grvCounterRef, { nextGRV: currentGRV + 1 }, { merge: true });
                
                // Mark items as processed locally
                items.forEach(item => {
                    if (item.grvNumber === `GRV-${currentGRV.toString().padStart(2, '0')}`) {
                        item.status = 'processed';
                    }
                });
                
                // Add to processed GRVs history
                processedGRVs.push(grv);
                
                // Update for next GRV
                currentGRV++;
                
                // Update display and save
                await getNextGRVNumber(); // Get updated GRV number from DB
                updateTable();
                updateSummary();
                updateGRVHistory();
                saveLocalData();
                
                showMessage(
                    `GRV-${(currentGRV-1).toString().padStart(2, '0')} processed successfully. ${grv.totalItems} items, ${grv.totalQuantity} units, Total: ${grv.totalValue.toFixed(2)}. Next items will go to GRV-${currentGRV.toString().padStart(2, '0')}`,
                    'success'
                );
                
            } catch (error) {
                console.error('Error processing GRV:', error);
                showMessage('Error processing GRV. Please try again.', 'error');
            }
        }

        // Update GRV history display
        function updateGRVHistory() {
            const historyBody = document.getElementById('grvHistoryBody');
            historyBody.innerHTML = '';
            
            if (processedGRVs.length === 0) {
                historyBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 15px; color: #666666;">
                            No GRV files processed yet.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Show latest first
            const sortedHistory = [...processedGRVs].reverse();
            
            sortedHistory.forEach(grv => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${grv.grvNumber}</td>
                    <td>${grv.date}</td>
                    <td>${grv.time}</td>
                    <td>${grv.totalItems}</td>
                    <td>${grv.totalQuantity}</td>
                    <td>${grv.totalValue.toFixed(2)}</td>
                `;
                historyBody.appendChild(row);
            });
        }

        // Show message
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = text;
            messageDiv.className = `message message-${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Fetch existing GRV records from database
        async function fetchExistingGRVs() {
            try {
                const q = query(collection(db, 'grvRecords'), where('branchId', '==', branchId));
                const grvSnapshot = await getDocs(q);
                processedGRVs = grvSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateGRVHistory();
                saveLocalData();
            } catch (error) {
                console.error('Error fetching GRV records:', error);
            }
        }

        // Auto-fill item name when code is entered
        document.getElementById('itemCode').addEventListener('blur', function() {
            const code = this.value.trim();
            if (code && inventory.length > 0) {
                const item = inventory.find(inv => inv.code === code);
                if (item) {
                    document.getElementById('itemName').value = item.name;
                }
            }
        });

        // Initialize
        window.onload = async function() {
            await getNextGRVNumber();
            await fetchInventory();
            loadLocalData();
            await fetchExistingGRVs();
            document.getElementById('itemCode').focus();
        };

        // Make functions available globally
        window.addItem = addItem;
        window.deleteItem = deleteItem;
        window.processGRV = processGRV;
    </script>
</body>
</html>
